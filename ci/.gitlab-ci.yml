stages:
  - static-test
  - compile
  - test
  #  - sanitizer TODO
  - coverage
  - docs


image: $CI_REGISTRY/maierhofer/environment-model/ci-test:0.4.99

before_script:
  - source activate commonroad
  - pip install tox coverage
  - pip install -r ./requirements.txt
  - pip install -r ./test_requirements.txt

### static test ###
clang-format:
  stage: static-test
  script:
    bash ./ci/clang-format.sh

clang-tidy:
  stage: static-test
  script:
    # run CMake in order to get compile_commands.json
    - mkdir build && cd build
    - DrivabilityChecker_DIR=/commonroad/commonroad-drivability-checker/build cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_BUILD_TYPE=Debug ..
    - cd ..
    - bash ./ci/clang-tidy.sh


### build project ###
build-clang:
  stage: compile
  script:
    - export CC=clang
    - export CXX=clang++
    - mkdir build && cd build
    - DrivabilityChecker_DIR=/commonroad/commonroad-drivability-checker/build cmake -DCMAKE_BUILD_TYPE=Release ..
    - make env_model -j4

build-gcc:
  stage: compile
  script:
    - export CC=gcc
    - export CXX=g++
    - mkdir build && cd build
    - DrivabilityChecker_DIR=/commonroad/commonroad-drivability-checker/build cmake -DCMAKE_BUILD_TYPE=Release ..
    - make env_model -j4

build-standalone:
  stage: compile
  script:
    - mkdir build && cd build
    - DrivabilityChecker_DIR=/commonroad/commonroad-drivability-checker/build cmake -DCMAKE_BUILD_TYPE=Release ..
    - make env_model_example_node -j4

build-test:
  stage: compile
  script:
    - mkdir build && cd build
    - DrivabilityChecker_DIR=/commonroad/commonroad-drivability-checker/build cmake -DCMAKE_BUILD_TYPE=Debug ..
    - make env_model_test -j4
  artifacts:
    paths:
      - build/env_model_test
      - build/libenv_model.so
      - ./tests/testScenarios/*
    expire_in: 20 minutes

build-run-coverage:
  stage: compile
  script:
    - mkdir build && cd build
    - DrivabilityChecker_DIR=/commonroad/commonroad-drivability-checker/build cmake -DCODE_COVERAGE=ON -DCMAKE_CXX_FLAGS=--coverage -DCMAKE_BUILD_TYPE=Debug ..
    - make env_model_coverage -j4
  artifacts:
    paths:
      - ./build/
      - ./env_model_coverage
    expire_in: 20 minutes


### tests ###
test:
  stage: test
  script:
    - build/env_model_test --gtest_output="xml:report.xml"
    - python setup.py develop --crccosy /commonroad/commonroad-drivability-checker
    - python -m pytest tests/python
  dependencies:
    - build-test
  artifacts:
    reports:
      junit: ./report.xml

### coverage ###
publish-coverage:
  stage: coverage
  script:
    - gcovr -e src/commonroad_cpp/interfaces/commonroad/pugi_xml/pugixml.hpp -e src/commonroad_cpp/interfaces/commonroad/pugi_xml/pugixml.cpp -e src/commonroad_cpp/interfaces/standalone/main.cpp -e src/commonroad_cpp/interfaces/pybind/ -e external/ -e 'cmake-(.+/)?/' -e tests/ -e build/CMakeFiles/
  dependencies:
    - build-run-coverage

### create documentation ###
docs:
  stage: docs
  script:
    - cd build
    - DrivabilityChecker_DIR=/commonroad/commonroad-drivability-checker/build cmake -DBUILD_DOXYGEN=ON -DCMAKE_BUILD_TYPE=Debug ..
    - make doc_doxygen ..
